'use strict';var _extends=Object.assign||function(target){for(var source,i=1;i<arguments.length;i++)for(var key in source=arguments[i],source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key]);return target},_createClass=function(){function defineProperties(target,props){for(var descriptor,i=0;i<props.length;i++)descriptor=props[i],descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,'value'in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_isomorphicFetch=require('isomorphic-fetch'),_isomorphicFetch2=_interopRequireDefault(_isomorphicFetch),_urlencode=require('urlencode'),_urlencode2=_interopRequireDefault(_urlencode),_jsMd=require('js-md5'),_jsMd2=_interopRequireDefault(_jsMd),_ErrorBadRequest=require('./ErrorBadRequest'),_ErrorBadRequest2=_interopRequireDefault(_ErrorBadRequest),_ErrorCache=require('./ErrorCache'),_ErrorCache2=_interopRequireDefault(_ErrorCache);Object.defineProperty(exports,'__esModule',{value:!0});function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _asyncToGenerator(fn){return function(){var gen=fn.apply(this,arguments);return new Promise(function(resolve,reject){function step(key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}return info.done?void resolve(value):Promise.resolve(value).then(function(value){step('next',value)},function(err){step('throw',err)})}return step('next')})}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError('Cannot call a class as a function')}var TMMicroServiceAPI=function(){function TMMicroServiceAPI(url){var token=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(_classCallCheck(this,TMMicroServiceAPI),_initialiseProps.call(this),this.url=url,this.token=token,this.cache=void 0!==process&&void 0!==process.env&&void 0!==process.env.TM_CACHE_CONFIG,this.log=!1,!0===this.cache)try{this.cacheConfig='string'==typeof process.env.TM_CACHE_CONFIG?JSON.parse(process.env.TM_CACHE_CONFIG):process.env.TM_CACHE_CONFIG,this.log=this.cacheConfig.log,(void 0===this.cacheConfig[this.url]||!1===this.cacheConfig[this.url].enabled)&&(this.cache=!1)}catch(error){}if(!0===this.cache){var Memcached=require('memcached'),uri=process.env.TM_CACHE_SERVER||'127.0.0.1:11211';this.memcached=new Memcached(uri)}var tmpVersion=this.url.match(/\/v[\d]+(.[\d]+)?(.[\d]+)?/);this.version=null===tmpVersion?'v1':TMMicroServiceAPI.checkVersion(tmpVersion[0].slice(1)),this.setToken=this.setToken.bind(this),this.request=this.request.bind(this)}return _createClass(TMMicroServiceAPI,[{key:'serializeResponse',value:function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark(function _callee(response){var modified,text,json;return regeneratorRuntime.wrap(function(_context){for(;;)switch(_context.prev=_context.next){case 0:return modified={ok:response.ok,url:response.url,type:response.type,status:response.status,statusText:response.statusText,redirected:response.redirected,headers:{_headers:response.headers.raw()},json:null,text:null},text=null,_context.prev=2,_context.next=5,response.text();case 5:text=_context.sent,_context.next=10;break;case 8:_context.prev=8,_context.t0=_context['catch'](2);case 10:json=null;try{null!==text&&0<text.trim().length&&(json=JSON.parse(text))}catch(error){}return _context.abrupt('return',_extends({},modified,{text:text,json:json}));case 13:case'end':return _context.stop();}},_callee,this,[[2,8]])}));return function serializeResponse(){return _ref.apply(this,arguments)}}()},{key:'setToMemcached',value:function setToMemcached(key,value,ttl){var _this=this;return new Promise(function(resolve,reject){_this.memcached.set(key,value,ttl,function(error){return error?reject(error):resolve()})})}},{key:'getFromMemcached',value:function getFromMemcached(key){var _this2=this;return new Promise(function(resolve,reject){_this2.memcached.get(key,function(error,data){error||void 0===data?reject(error):resolve(data)})})}},{key:'request',value:function(){var _ref2=_asyncToGenerator(regeneratorRuntime.mark(function _callee2(url,userOptions){var requestStart,requestEnd,updatedUrl,headers,defaultOptions,options,encodedData,uri,key,response,serialized;return regeneratorRuntime.wrap(function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:if(void 0!==url){_context2.next=2;break}throw new _ErrorBadRequest2.default(400,TMMicroServiceAPI.messages.badRequest);case 2:if(requestStart=void 0,requestEnd=void 0,this.log&&(requestStart=process.hrtime()),updatedUrl=url.replace(/\/v[\d]+(.[\d]+)?(.[\d]+)?/i,'/'+this.version),headers={"Content-Type":'application/x-www-form-urlencoded',Accept:'application/json; charset=utf-8'},null!==this.token&&(headers=_extends({},headers,{Authorization:this.token})),defaultOptions={method:'GET',headers:headers,data:{}},options=_extends({},defaultOptions,userOptions),options.headers=_extends({},headers,options.headers),encodedData=_urlencode2.default.stringify(options.data),uri=0===encodedData.length?updatedUrl:updatedUrl+'?'+encodedData,key=uri+'---'+(0,_jsMd2.default)(JSON.stringify(options)),response=void 0,!0!==this.cache){_context2.next=26;break}return _context2.prev=16,_context2.next=19,this.getFromMemcached(key);case 19:if(response=_context2.sent,void 0===response){_context2.next=22;break}return _context2.abrupt('return',TMMicroServiceAPI.parseResponse(response));case 22:_context2.next=26;break;case 24:_context2.prev=24,_context2.t0=_context2['catch'](16);case 26:return _context2.next=28,(0,_isomorphicFetch2.default)(uri,options);case 28:if(response=_context2.sent,!0!==this.cache||!0!==response.ok){_context2.next=41;break}return _context2.prev=30,_context2.next=33,this.serializeResponse(response.clone());case 33:return serialized=_context2.sent,_context2.next=36,this.setToMemcached(key,serialized,parseInt(this.cacheConfig[this.url].ttl,10));case 36:_context2.next=41;break;case 38:throw _context2.prev=38,_context2.t1=_context2['catch'](30),new _ErrorCache2.default(_context2.t1);case 41:return this.log&&(requestEnd=process.hrtime(),requestStart=parseInt(1e3*requestStart[0]+1e-6*requestStart[1],10),requestEnd=parseInt(1e3*requestEnd[0]+1e-6*requestEnd[1],10),console.log('\n        \u0417\u0430\u043F\u0440\u043E\u0441: '+(void 0===options.method?'GET':options.method)+' '+uri+'\n        \u0412\u0440\u0435\u043C\u044F \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u044F \u0434\u0430\u043D\u043D\u044B\u0445: '+(requestEnd-requestStart)+' \u043C\u0441.\n      ')),_context2.abrupt('return',response);case 43:case'end':return _context2.stop();}},_callee2,this,[[16,24],[30,38]])}));return function request(){return _ref2.apply(this,arguments)}}()}],[{key:'checkVersion',value:function checkVersion(version){if(!/^v[\d]+(.[\d]+)?(.[\d]+)?$/i.test(version))throw new Error(TMMicroServiceAPI.messages.version);return version}},{key:'parseResponse',value:function parseResponse(response){var headers=_extends({},response.headers);headers.get=function(name){var header=headers._headers[name.toLowerCase()];return header?header[0]:null},headers.has=function(name){return headers._headers.hasOwnProperty(name.toLowerCase())},headers.raw=function(){return headers._headers},headers.getAll=function(name){return headers.has(name)?headers._headers[name.toLowerCase()]:[]};return _extends({},response,{json:function json(){return new Promise(function(resolve){resolve(response.json)})},text:function text(){return new Promise(function(resolve){resolve(response.text)})},headers:headers})}}]),TMMicroServiceAPI}();TMMicroServiceAPI.messages={url:'Wrong Service URL Format',version:'Wrong Version Format',badRequest:'Bad Request'};var _initialiseProps=function(){var _this3=this;this.setToken=function(token){_this3.token=token},this.setVersion=function(version){_this3.version=TMMicroServiceAPI.checkVersion(version)}};exports.default=TMMicroServiceAPI;
//# sourceMappingURL=TMMicroServiceAPI.js.map